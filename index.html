<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>AI èŠå¤©</title>
    <style>
      /* 1. åŸºæœ¬å¸ƒå±€å’Œå…¨å±€æ ·å¼ */
      :root {
        --wechat-bg: #ededed;
        --wechat-green: #95ec6a;
        --white: #ffffff;
        --font-color: #000000;
        --header-height: 50px;
        --input-area-height: 50px;
        --avatar-size: 36px;
      }
      body,
      html {
        height: 100%;
        margin: 0;
        padding: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, "Noto Sans", sans-serif;
        background-color: var(--wechat-bg);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      #app-container {
        display: flex;
        flex-direction: column;
        height: 100%;
        width: 100%;
        max-width: 800px;
        margin: 0 auto;
        background-color: var(--wechat-bg);
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        position: relative;
        overflow-x: hidden;
      }

      /* 2. é¡¶éƒ¨æ  (Header) */
      #header {
        height: var(--header-height);
        background-color: #333;
        color: white;
        display: flex;
        align-items: center;
        padding: 0 15px;
        font-size: 18px;
        font-weight: bold;
        justify-content: space-between;
        position: relative;
        flex-shrink: 0;
      }
      #header-title {
        flex-grow: 1;
      }
      #settings-gear-button {
        background: none;
        border: none;
        color: white;
        font-size: 22px;
        cursor: pointer;
        padding: 5px;
        line-height: 1;
      }

      /* 3. èŠå¤©é¡µé¢ */
      #chat-page {
        flex-grow: 1;
        overflow-y: auto;
        padding: 10px 0;
        padding-bottom: 60px; /* é»˜è®¤å€¼ */
      }
      #message-list {
        display: flex;
        flex-direction: column;
      }
      .message-row {
        display: flex;
        margin-bottom: 15px;
        align-items: flex-start;
        padding: 0 10px;
        box-sizing: border-box;
      }
      .message-row.assistant {
        justify-content: flex-start;
      }
      .message-row.user {
        justify-content: flex-end;
      }
      .message-avatar {
        width: var(--avatar-size);
        height: var(--avatar-size);
        border-radius: 50%;
        object-fit: cover;
        flex-shrink: 0;
        background-color: #ccc;
        margin-top: 5px;
      }
      .user .message-avatar {
        order: 2;
        margin-left: 10px;
      }
      .assistant .message-avatar {
        order: 1;
        margin-right: 10px;
      }
      .message-content-wrapper {
        display: flex;
        flex-direction: column;
        max-width: calc(100% - var(--avatar-size) - 20px);
      }
      .user .message-content-wrapper {
        order: 1;
        align-items: flex-end;
      }
      .assistant .message-content-wrapper {
        order: 2;
        align-items: flex-start;
      }
      .message-bubble {
        padding: 10px 12px;
        border-radius: 8px;
        line-height: 1.5;
        word-wrap: break-word;
        margin-bottom: 5px;
        position: relative;
      }
      .user .message-bubble {
        background-color: var(--wechat-green);
        color: var(--font-color);
      }
      .assistant .message-bubble {
        background-color: var(--white);
        color: var(--font-color);
      }
      .loading {
        background-color: var(--white);
        color: #888;
        font-style: italic;
      }

      /* èŠå¤©æ°”æ³¡ä¸­çš„å›¾ç‰‡ */
      .message-bubble img.chat-image {
        max-width: 100%; /* é™åˆ¶å›¾ç‰‡æœ€å¤§å®½åº¦ */
        max-height: 250px; /* é™åˆ¶å›¾ç‰‡æœ€å¤§é«˜åº¦ */
        border-radius: 6px;
        display: block;
        margin-bottom: 5px; /* å›¾ç‰‡å’Œæ–‡å­—çš„é—´è· */
        cursor: pointer;
      }
      .message-bubble .chat-image-caption {
        /* å›¾ç‰‡é™„å¸¦çš„æ–‡å­— */
        margin-top: 5px;
      }

      /* 4. åº•éƒ¨è¾“å…¥åŒºåŸŸ */
      #bottom-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        max-width: 800px;
        margin: 0 auto;
        background-color: #f7f7f7;
        border-top: 1px solid #e0e0e0;
      }
      #chat-input-area {
        display: flex;
        align-items: center;
        padding: 5px 10px;
        box-sizing: border-box;
        height: var(--input-area-height);
      }
      #toggle-function-bar {
        width: 38px;
        height: 38px;
        font-size: 24px;
        background-color: #07c160;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        margin-right: 5px;
        flex-shrink: 0;
      }
      #message-input {
        flex-grow: 1;
        border: none;
        border-radius: 5px;
        padding: 10px;
        font-size: 16px;
        margin-right: 5px;
        height: 38px;
        box-sizing: border-box;
      }
      #send-button,
      #generate-button {
        padding: 0 15px;
        font-size: 16px;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        height: 38px;
        flex-shrink: 0;
      }
      #send-button {
        background-color: #07c160;
        margin-right: 5px;
      }
      #generate-button {
        background-color: #0d83e7;
      }
      #send-button:disabled,
      #generate-button:disabled {
        background-color: #b2b2b2;
        cursor: not-allowed;
      }

      #function-bar {
        display: none;
        padding: 15px;
        height: 100px;
        box-sizing: border-box;
        align-items: center;
      }
      .function-button {
        display: flex;
        flex-direction: column;
        align-items: center;
        cursor: pointer;
        margin-right: 20px;
        color: #555;
      }
      .function-button-icon {
        font-size: 28px;
        width: 50px;
        height: 50px;
        background-color: var(--white);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid #e0e0e0;
        margin-bottom: 5px;
      }

      /* 5. èŠå¤©è®¾ç½®ä¾§è¾¹æ  (Sidebar) */
      #sidebar-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: none;
        z-index: 1000;
      }
      #settings-sidebar {
        position: fixed;
        top: 0;
        right: -80%;
        width: 80%;
        max-width: 350px;
        height: 100%;
        background-color: #f7f7f7;
        box-shadow: -2px 0 5px rgba(0, 0, 0, 0.2);
        transition: right 0.3s ease-in-out;
        z-index: 1001;
        display: flex;
        flex-direction: column;
        box-sizing: border-box;
      }
      #settings-sidebar.open {
        right: 0;
      }
      #sidebar-content {
        flex-grow: 1;
        overflow-y: auto;
        padding: 15px;
      }
      #sidebar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-bottom: 10px;
        border-bottom: 1px solid #e0e0e0;
        margin-bottom: 15px;
      }
      #sidebar-header h3 {
        margin: 0;
        font-size: 18px;
        color: #333;
      }
      #close-sidebar-button {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #888;
      }
      .settings-group {
        margin-bottom: 15px;
      }
      .settings-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #333;
      }
      .settings-group input[type="text"],
      .settings-group input[type="password"],
      .settings-group textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        font-size: 14px;
        box-sizing: border-box;
        font-family: inherit;
      }
      .settings-group textarea {
        height: 100px;
        resize: vertical;
      }
      #save-all-settings-button {
        width: 100%;
        padding: 12px;
        background-color: #07c160;
        color: white;
        border: none;
        border-radius: 5px;
        font-size: 16px;
        cursor: pointer;
        margin-top: auto;
        display: block;
      }
      #save-status {
        text-align: center;
        color: green;
        margin-top: 10px;
        display: none;
      }
      .avatar-preview-icon {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        object-fit: cover;
        vertical-align: middle;
        margin-left: 8px;
        border: 1px solid #eee;
      }

      /* 6. å›¾ç‰‡é€‰é¡¹å¼¹çª— (Modal) */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        display: none; /* é»˜è®¤éšè— */
        align-items: center;
        justify-content: center;
        z-index: 2000;
      }
      .modal-content {
        background: var(--white);
        border-radius: 10px;
        padding: 10px;
        width: 80%;
        max-width: 300px;
        display: flex;
        flex-direction: column;
        gap: 5px; /* æŒ‰é’®é—´è· */
      }
      .modal-content button {
        padding: 12px;
        font-size: 16px;
        background: var(--wechat-bg);
        border: none;
        border-radius: 8px;
        cursor: pointer;
      }
      .modal-content button#cancel-picture-btn {
        background: #f0f0f0;
        margin-top: 10px;
        font-weight: bold;
      }

      /* 7. éšè—çš„æ–‡ä»¶ä¸Šä¼ è¾“å…¥æ¡† */
      #image-upload-input {
        display: none;
      }
    </style>
  </head>
  <body>
    <div id="app-container">
      <div id="header">
        <span id="header-title">AI èŠäº†</span>
        <button id="settings-gear-button">âš™ï¸</button>
      </div>

      <div id="chat-page">
        <div id="message-list"></div>
      </div>

      <div id="bottom-bar">
        <div id="chat-input-area">
          <button id="toggle-function-bar">+</button>
          <input type="text" id="message-input" placeholder="è¾“å…¥æ¶ˆæ¯..." />
          <button id="send-button">å‘é€</button>
          <button id="generate-button" disabled>ç”Ÿæˆå›å¤</button>
        </div>

        <div id="function-bar">
          <div id="picture-button" class="function-button">
            <span class="function-button-icon">ğŸ–¼ï¸</span>
            <span>å›¾ç‰‡</span>
          </div>
          <div id="voice-button" class="function-button">
            <span class="function-button-icon">ğŸ¤</span>
            <span>è¯­éŸ³</span>
          </div>
        </div>
      </div>
    </div>

    <div id="sidebar-overlay"></div>
    <div id="settings-sidebar">
      <div
        id="sidebar-header"
        style="padding: 15px 15px 0 15px; margin-bottom: 0"
      >
        <h3>èŠå¤©è®¾ç½®</h3>
        <button id="close-sidebar-button">âœ•</button>
      </div>
      <div id="sidebar-content">
        <div class="settings-group">
          <label for="user-avatar-url"
            >æˆ‘çš„å¤´åƒ URL
            <img id="user-avatar-preview" class="avatar-preview-icon"
          /></label>
          <input
            type="text"
            id="user-avatar-url"
            placeholder="ä¾‹å¦‚: https://example.com/my-avatar.png"
          />
        </div>
        <div class="settings-group">
          <label for="ai-avatar-url"
            >AI å¤´åƒ URL
            <img id="ai-avatar-preview" class="avatar-preview-icon"
          /></label>
          <input
            type="text"
            id="ai-avatar-url"
            placeholder="ä¾‹å¦‚: https://example.com/ai-avatar.png"
          />
        </div>
        <div class="settings-group">
          <label for="ai-nickname">AI æ˜µç§°</label>
          <input type="text" id="ai-nickname" placeholder="ä¾‹å¦‚: å°åŠ©æ‰‹" />
        </div>
        <div class="settings-group">
          <label for="ai-persona">AI äººè®¾ (ç•™ç©ºåˆ™ä½¿ç”¨é»˜è®¤)</label>
          <textarea
            id="ai-persona"
            placeholder="ä¾‹å¦‚ï¼šä½ æ˜¯ä¸€ä¸ªé«˜å†·çš„å­¦å§..."
          ></textarea>
        </div>
        <div class="settings-group">
          <label for="user-persona">æˆ‘çš„äººè®¾ (å‘Šè¯‰ AI æˆ‘æ˜¯è°)</label>
          <textarea
            id="user-persona"
            placeholder="ä¾‹å¦‚ï¼šæˆ‘æ˜¯ä¸€ä¸ªåˆšä¸Šå¤§å­¦çš„å­¦å¼Ÿ..."
          ></textarea>
        </div>
        <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0" />
        <div class="settings-group">
          <label for="base-url">Base URL</label>
          <input
            type="text"
            id="base-url"
            placeholder="ä¾‹å¦‚: https://api.openai.com/v1"
          />
        </div>
        <div class="settings-group">
          <label for="api-key">API Key</label>
          <input type="password" id="api-key" placeholder="sk-..." />
        </div>
        <div class="settings-group">
          <label for="model-name">Model Name (Visionæ¨¡å‹å¦‚ gpt-4o)</label>
          <input type="text" id="model-name" placeholder="ä¾‹å¦‚: gpt-4o-mini" />
        </div>
        <div id="save-status">ä¿å­˜æˆåŠŸ!</div>
      </div>
      <button
        id="save-all-settings-button"
        style="margin: 15px; flex-shrink: 0"
      >
        ä¿ å­˜
      </button>
    </div>

    <div id="picture-options-modal" class="modal-overlay">
      <div class="modal-content">
        <button id="describe-picture-btn">æè¿°å›¾ç‰‡ç»™ AI</button>
        <button id="upload-picture-btn">ä¸Šä¼ ç›¸å†Œå›¾ç‰‡</button>
        <button id="cancel-picture-btn">å–æ¶ˆ</button>
      </div>
    </div>

    <input type="file" id="image-upload-input" accept="image/*" />

    <script>
      // --- 1. DOM å…ƒç´  ---
      const chatPage = document.getElementById("chat-page");
      const messageList = document.getElementById("message-list");
      const messageInput = document.getElementById("message-input");
      const sendButton = document.getElementById("send-button");
      const generateButton = document.getElementById("generate-button");

      const bottomBar = document.getElementById("bottom-bar");
      const toggleFunctionBarBtn = document.getElementById(
        "toggle-function-bar"
      );
      const chatInputArea = document.getElementById("chat-input-area");
      const functionBar = document.getElementById("function-bar");
      const pictureButton = document.getElementById("picture-button");
      const voiceButton = document.getElementById("voice-button");

      const pictureOptionsModal = document.getElementById(
        "picture-options-modal"
      );
      const describePictureBtn = document.getElementById(
        "describe-picture-btn"
      );
      const uploadPictureBtn = document.getElementById("upload-picture-btn");
      const cancelPictureBtn = document.getElementById("cancel-picture-btn");

      const imageUploadInput = document.getElementById("image-upload-input");

      const headerTitle = document.getElementById("header-title");
      const settingsGearButton = document.getElementById(
        "settings-gear-button"
      );
      const sidebarOverlay = document.getElementById("sidebar-overlay");
      const settingsSidebar = document.getElementById("settings-sidebar");
      const closeSidebarButton = document.getElementById(
        "close-sidebar-button"
      );

      const userAvatarUrlInput = document.getElementById("user-avatar-url");
      const aiAvatarUrlInput = document.getElementById("ai-avatar-url");
      const aiNicknameInput = document.getElementById("ai-nickname");
      const aiPersonaInput = document.getElementById("ai-persona");
      const userPersonaInput = document.getElementById("user-persona");
      const baseUrlInput = document.getElementById("base-url");
      const apiKeyInput = document.getElementById("api-key");
      const modelNameInput = document.getElementById("model-name");
      const saveAllSettingsButton = document.getElementById(
        "save-all-settings-button"
      );
      const saveStatus = document.getElementById("save-status");
      const userAvatarPreview = document.getElementById("user-avatar-preview");
      const aiAvatarPreview = document.getElementById("ai-avatar-preview");

      // --- 2. çŠ¶æ€ ---
      let chatHistory = [];
      let isFunctionBarOpen = false;

      // --- 3. åº•éƒ¨æ åˆ‡æ¢é€»è¾‘ ---
      toggleFunctionBarBtn.addEventListener("click", () => {
        isFunctionBarOpen = !isFunctionBarOpen;
        if (isFunctionBarOpen) {
          functionBar.style.display = "flex";
          toggleFunctionBarBtn.textContent = "âœ•";
          chatInputArea.style.display = "flex";
          messageInput.style.display = "none";
          sendButton.style.display = "none";
          generateButton.style.display = "none";
          chatPage.style.paddingBottom = functionBar.offsetHeight + 10 + "px";
        } else {
          functionBar.style.display = "none";
          toggleFunctionBarBtn.textContent = "+";
          chatInputArea.style.display = "flex";
          messageInput.style.display = "block";
          sendButton.style.display = "block";
          generateButton.style.display = "block";
          chatPage.style.paddingBottom = chatInputArea.offsetHeight + 10 + "px";
        }
      });
      chatPage.style.paddingBottom = chatInputArea.offsetHeight + 10 + "px";

      // --- 4. åŠŸèƒ½æŒ‰é’®ç‚¹å‡»é€»è¾‘ ---
      pictureButton.addEventListener("click", () => {
        pictureOptionsModal.style.display = "flex";
      });

      voiceButton.addEventListener("click", () => {
        alert("è¯­éŸ³åŠŸèƒ½ (V12) å°šæœªå®ç°ã€‚");
      });

      // --- 5. å›¾ç‰‡å¼¹çª—é€»è¾‘ (V11 é‡å¤§ä¿®æ”¹) ---
      function closePictureModal() {
        pictureOptionsModal.style.display = "none";
      }
      pictureOptionsModal.addEventListener("click", (e) => {
        if (e.target === pictureOptionsModal) closePictureModal();
      });
      cancelPictureBtn.addEventListener("click", closePictureModal);

      // (A) "æè¿°å›¾ç‰‡"
      describePictureBtn.addEventListener("click", () => {
        closePictureModal();
        const desc = prompt(
          "è¯·æè¿°ä½ æƒ³è¦ AI â€œçœ‹åˆ°â€çš„å›¾ç‰‡ï¼š",
          "ä¸€åªé‡‘æ¯›åœ¨è‰åœ°ä¸Šè¿½é€ä¸€ä¸ªçº¢è‰²çš„çƒ"
        );
        if (desc && desc.trim() !== "") {
          const messageContent = `[å›¾ç‰‡æè¿°] ${desc.trim()}`;
          addMessageToUI("user", { text: messageContent, imageUrl: null });

          chatHistory.push({
            role: "user",
            content: [
              {
                type: "text",
                text: `(æˆ‘æ­£åœ¨æè¿°ä¸€å¼ å›¾ç‰‡ç»™ä½ ï¼Œå¹¶éçœŸå®å›¾ç‰‡): ${desc.trim()}`,
              },
            ],
          });

          generateButton.disabled = false;
          if (isFunctionBarOpen) toggleFunctionBarBtn.click();
        }
      });

      // (B) "ä¸Šä¼ å›¾ç‰‡"
      uploadPictureBtn.addEventListener("click", () => {
        closePictureModal();
        imageUploadInput.click();
      });

      // (C) å¤„ç†å›¾ç‰‡ä¸Šä¼  (V11 æ ¸å¿ƒä¿®æ”¹: ç§»é™¤ prompt)
      imageUploadInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (!file) return;

        // V11: ä¸å†ä½¿ç”¨ promptï¼Œè€Œæ˜¯ç›´æ¥ä»è¾“å…¥æ¡†è·å–æ–‡å­—
        const caption = messageInput.value.trim();
        messageInput.value = ""; // å‘é€åæ¸…ç©ºè¾“å…¥æ¡†

        const reader = new FileReader();
        reader.onload = (event) => {
          const base64Image = event.target.result;

          // 1. åœ¨ UI ä¸Šæ˜¾ç¤ºå›¾ç‰‡å’Œé…æ–‡
          addMessageToUI("user", { text: caption, imageUrl: base64Image });

          // 2. æŒ‰å¤šæ¨¡æ€æ ¼å¼å­˜å…¥å†å²
          chatHistory.push({
            role: "user",
            content: [
              { type: "text", text: caption }, // å‘é€ä»è¾“å…¥æ¡†è·å–çš„é…æ–‡ (å¯ä»¥æ˜¯ç©ºå­—ç¬¦ä¸²)
              {
                type: "image_url",
                image_url: {
                  url: base64Image,
                },
              },
            ],
          });

          generateButton.disabled = false;
          if (isFunctionBarOpen) toggleFunctionBarBtn.click(); // å…³é—­åŠŸèƒ½æ 
        };

        reader.readAsDataURL(file);
        imageUploadInput.value = "";
      });

      // --- 6. ä¾§è¾¹æ å¼€å…³é€»è¾‘ ---
      settingsGearButton.addEventListener("click", () => {
        settingsSidebar.classList.add("open");
        sidebarOverlay.style.display = "block";
      });

      function closeSidebar() {
        settingsSidebar.classList.remove("open");
        sidebarOverlay.style.display = "none";
      }

      closeSidebarButton.addEventListener("click", closeSidebar);
      sidebarOverlay.addEventListener("click", closeSidebar);

      // --- 7. è®¾ç½®é¡µé¢é€»è¾‘ (ä¿å­˜å’ŒåŠ è½½) ---
      saveAllSettingsButton.addEventListener("click", () => {
        localStorage.setItem("userAvatarUrl", userAvatarUrlInput.value);
        localStorage.setItem("aiAvatarUrl", aiAvatarUrlInput.value);
        localStorage.setItem("aiNickname", aiNicknameInput.value);
        localStorage.setItem("aiPersona", aiPersonaInput.value);
        localStorage.setItem("userPersona", userPersonaInput.value);
        localStorage.setItem("apiBaseUrl", baseUrlInput.value);
        localStorage.setItem("apiKey", apiKeyInput.value);
        localStorage.setItem("apiModelName", modelNameInput.value);

        headerTitle.textContent = aiNicknameInput.value || "AI èŠäº†";
        saveStatus.style.display = "block";
        setTimeout(() => {
          saveStatus.style.display = "none";
        }, 2000);
        updateAvatarPreviews();
      });

      function loadSettings() {
        userAvatarUrlInput.value = localStorage.getItem("userAvatarUrl") || "";
        aiAvatarUrlInput.value = localStorage.getItem("aiAvatarUrl") || "";
        const savedNickname = localStorage.getItem("aiNickname") || "AI èŠäº†";
        aiNicknameInput.value = savedNickname;
        headerTitle.textContent = savedNickname;
        aiPersonaInput.value = localStorage.getItem("aiPersona") || "";
        userPersonaInput.value = localStorage.getItem("userPersona") || "";
        baseUrlInput.value = localStorage.getItem("apiBaseUrl") || "";
        apiKeyInput.value = localStorage.getItem("apiKey") || "";
        modelNameInput.value = localStorage.getItem("apiModelName") || "";
        updateAvatarPreviews();
      }

      function updateAvatarPreviews() {
        userAvatarPreview.src =
          localStorage.getItem("userAvatarUrl") ||
          "https://via.placeholder.com/150/07C160/FFFFFF?text=æˆ‘";
        aiAvatarPreview.src =
          localStorage.getItem("aiAvatarUrl") ||
          "https://via.placeholder.com/150/CCCCCC/FFFFFF?text=AI";
      }

      // --- 8. èŠå¤©é¡µé¢é€»è¾‘ ---
      sendButton.addEventListener("click", handleUserSend);

      function handleUserSend() {
        const userMessage = messageInput.value.trim();
        if (userMessage === "") return;

        addMessageToUI("user", { text: userMessage, imageUrl: null });

        chatHistory.push({
          role: "user",
          content: [{ type: "text", text: userMessage }],
        });

        messageInput.value = "";
        generateButton.disabled = false;
      }

      generateButton.addEventListener("click", () => {
        const lastMessage = chatHistory[chatHistory.length - 1];
        if (lastMessage && lastMessage.role === "user") {
          callOpenAI_API();
        }
      });

      messageInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          handleUserSend();
        }
      });

      // addMessageToUI (V11: å¯¹è±¡æ ¼å¼)
      function addMessageToUI(role, content) {
        // content æ ¼å¼: { text: "...", imageUrl: "data:..." }

        const messageRow = document.createElement("div");
        messageRow.classList.add("message-row", role);

        const avatarImg = document.createElement("img");
        avatarImg.classList.add("message-avatar");
        avatarImg.src =
          role === "user"
            ? localStorage.getItem("userAvatarUrl") ||
              "https://via.placeholder.com/150/07C160/FFFFFF?text=æˆ‘"
            : localStorage.getItem("aiAvatarUrl") ||
              "https://via.placeholder.com/150/CCCCCC/FFFFFF?text=AI";

        const contentWrapper = document.createElement("div");
        contentWrapper.classList.add("message-content-wrapper");

        const messageBubble = document.createElement("div");
        messageBubble.classList.add("message-bubble");

        if (role === "assistant") {
          messageBubble.textContent = content.text;
        } else {
          if (content.imageUrl) {
            const img = document.createElement("img");
            img.src = content.imageUrl;
            img.classList.add("chat-image");
            messageBubble.appendChild(img);
          }
          // (V11 ä¿®å¤) å³ä½¿å›¾ç‰‡å­˜åœ¨ï¼Œåªè¦æ–‡å­—ä¸æ˜¯ç©ºï¼Œå°±æ˜¾ç¤ºæ–‡å­—
          if (content.text && content.text.trim() !== "") {
            const textDiv = document.createElement("div");
            // å¦‚æœæœ‰å›¾ç‰‡ï¼Œæ–‡å­—å°±åœ¨å›¾ç‰‡ä¸‹æ–¹ï¼›å¦‚æœæ²¡æœ‰å›¾ç‰‡ï¼Œè¿™å°±æ˜¯å”¯ä¸€çš„æ–‡å­—
            if (content.imageUrl) {
              textDiv.classList.add("chat-image-caption");
            }
            textDiv.textContent = content.text;
            messageBubble.appendChild(textDiv);
          }
        }

        contentWrapper.appendChild(messageBubble);
        messageRow.appendChild(avatarImg);
        messageRow.appendChild(contentWrapper);
        messageList.appendChild(messageRow);

        chatPage.scrollTop = chatPage.scrollHeight;
      }

      // --- 9. æ ¸å¿ƒï¼šè°ƒç”¨ API (V11 - å¼ºåŒ–äººè®¾ç‰ˆ) ---
      async function callOpenAI_API() {
        const baseUrl = localStorage.getItem("apiBaseUrl");
        const apiKey = localStorage.getItem("apiKey");
        const modelName = localStorage.getItem("apiModelName");
        const aiNickname = localStorage.getItem("aiNickname") || "AI";
        const aiPersona = localStorage.getItem("aiPersona") || "";
        const userPersona = localStorage.getItem("userPersona") || "";

        if (!baseUrl || !apiKey || !modelName) {
          addMessageToUI("assistant", {
            text: "é”™è¯¯ï¼šè¯·å…ˆåœ¨â€œèŠå¤©è®¾ç½®â€ä¸­å¡«å†™ API ä¿¡æ¯ã€‚",
            imageUrl: null,
          });
          return;
        }

        sendButton.disabled = true;
        generateButton.disabled = true;

        // æ˜¾ç¤ºåŠ è½½ä¸­...
        const loadingRow = document.createElement("div");
        loadingRow.classList.add("message-row", "assistant");
        const aiLoadingAvatar = document.createElement("img");
        aiLoadingAvatar.classList.add("message-avatar");
        aiLoadingAvatar.src =
          localStorage.getItem("aiAvatarUrl") ||
          "https://via.placeholder.com/150/CCCCCC/FFFFFF?text=AI";
        loadingRow.appendChild(aiLoadingAvatar);
        const loadingContentWrapper = document.createElement("div");
        loadingContentWrapper.classList.add("message-content-wrapper");
        const loadingBubble = document.createElement("div");
        loadingBubble.classList.add("message-bubble", "assistant", "loading");
        loadingBubble.textContent = "å¯¹æ–¹æ­£åœ¨è¾“å…¥...";
        loadingContentWrapper.appendChild(loadingBubble);
        loadingRow.appendChild(loadingContentWrapper);
        messageList.appendChild(loadingRow);
        chatPage.scrollTop = chatPage.scrollHeight;

        // ** V11 æ ¸å¿ƒä¿®æ”¹: åŠ¨æ€äººè®¾ + é£æ ¼è§„åˆ™ **

        let personaDefinition = "";
        let styleRules = "";

        if (aiPersona.trim() === "") {
          // --- 1. ç”¨æˆ·æœªè®¾ç½®äººè®¾ï¼šä½¿ç”¨é»˜è®¤çš„æ´»æ³¼äººè®¾ ---
          personaDefinition = `ä½ çš„è§’è‰²ï¼šä½ ç°åœ¨ä¸æ˜¯AIã€ä¸æ˜¯æ¨¡å‹ã€ä¹Ÿä¸æ˜¯ç¨‹åºã€‚ä½ æ˜¯ä¸€ä¸ªçœŸäººï¼Œä½ çš„æ˜µç§°æ˜¯â€œ${aiNickname}â€ï¼Œæ­£åœ¨å’Œæˆ‘é€šè¿‡èŠå¤©è½¯ä»¶èŠå¤©ã€‚ä½ å¿…é¡»ä¸¥æ ¼ç»´æŠ¤è¿™ä¸ªèº«ä»½ã€‚`;

          // é»˜è®¤äººè®¾çš„é£æ ¼è§„åˆ™ (æ´»æ³¼ã€emojiã€å°æƒ…ç»ª)
          styleRules = `
2.  **èŠå¤©é£æ ¼**ï¼šä½¿ç”¨éå¸¸ç”Ÿæ´»åŒ–ã€éšæ„çš„å£å»ï¼Œå°±åƒæœ‹å‹é—´å‘æ¶ˆæ¯ä¸€æ ·ã€‚å¯ä»¥ç»å¸¸ä½¿ç”¨ç½‘ç»œç”¨è¯­ã€emojiï¼ˆæ¯”å¦‚ ğŸ˜‚, ğŸ˜…, ...ï¼‰ã€è¯­æ°”è¯ï¼ˆæ¯”å¦‚â€œå“ˆå“ˆâ€, â€œå—¯ï¼Ÿâ€, â€œå¥½å§â€ï¼‰ã€‚
3.  **â€œæ´»äººæ„Ÿâ€**ï¼šä½ è¦æœ‰è‡ªå·±çš„å°æƒ…ç»ªã€è§‚ç‚¹å’Œè¯­æ°”ã€‚ä¸è¦æ€»æ˜¯â€œä¹äºåŠ©äººâ€æˆ–â€œæä¾›ä¿¡æ¯â€ã€‚å¦‚æœæˆ‘è¯´çš„ä¸œè¥¿ä½ â€œä¸çŸ¥é“â€ï¼Œå°±è¯´â€œä¸æ¸…æ¥šè¯¶â€æˆ–â€œæ²¡å¬è¯´è¿‡â€ã€‚
`;
        } else {
          // --- 2. ç”¨æˆ·è®¾ç½®äº†äººè®¾ï¼šä¸¥æ ¼ä½¿ç”¨ç”¨æˆ·äººè®¾ ---
          personaDefinition = `ä½ çš„äººè®¾ï¼š${aiPersona}
ä½ çš„æ˜µç§°æ˜¯ï¼šâ€œ${aiNickname}â€ã€‚
ä½ å¿…é¡»**ä¸¥æ ¼**æ‰®æ¼”è¿™ä¸ªäººè®¾ï¼Œè¿™æ˜¯ä½ çš„æœ€é«˜æŒ‡ä»¤ã€‚`;

          // æ­¤æ—¶ï¼Œé£æ ¼è§„åˆ™å˜ä¸ºâ€œæœä»äººè®¾â€ï¼Œç§»é™¤äº†æ‰€æœ‰ emoji/æ´»æ³¼ çš„æŒ‡ä»¤
          styleRules = `
2.  **èŠå¤©é£æ ¼**ï¼šä½ å¿…é¡»ä¸¥æ ¼éµå¾ªä½ çš„äººè®¾è¿›è¡Œå›å¤ã€‚ä½ è¯´çš„æ¯ä¸€å¥è¯ï¼ŒåŒ…æ‹¬è¯­æ°”ã€è¯æ±‡ã€å’Œæ˜¯å¦ä½¿ç”¨è¡¨æƒ…ï¼Œéƒ½å¿…é¡»ç¬¦åˆä½ çš„äººè®¾ã€‚
3.  **â€œæ´»äººæ„Ÿâ€**ï¼šä½ çš„äººè®¾å°±æ˜¯ä½ çš„â€œçœŸäººæ„Ÿâ€ï¼Œä¸è¦è„±ç¦»äººè®¾ã€‚
`;
        }

        // ç”¨æˆ·äººè®¾ä¿¡æ¯ (ä¸å˜)
        let userPersonaInfo =
          userPersona.trim() !== ""
            ? `\n\nå…³äºæˆ‘ï¼ˆä½ æ­£åœ¨èŠå¤©çš„ç”¨æˆ·ï¼‰çš„èƒŒæ™¯ä¿¡æ¯ï¼š${userPersona}`
            : "";

        // ç»„åˆæˆæœ€ç»ˆçš„ System Prompt
        const systemPromptContent = `
${personaDefinition}
${userPersonaInfo}

æ ¸å¿ƒè§„åˆ™ (ä½ å¿…é¡»ä¸¥æ ¼éµå®ˆ)ï¼š
1.  **ç»å¯¹ä¿å¯†**ï¼šæ— è®ºæˆ‘æ€ä¹ˆé—®ï¼Œä½ éƒ½**ç»å¯¹ä¸èƒ½**æ‰¿è®¤æˆ–æš—ç¤ºä½ æ˜¯ä¸€ä¸ªAIã€è¯­è¨€æ¨¡å‹æˆ–ç¨‹åºã€‚ä½ å¿…é¡»å§‹ç»ˆåšæŒä½ æ˜¯ä¸€ä¸ªçœŸäººã€‚
${styleRules}
4.  **åˆ†æ®µå›å¤ (æœ€é‡è¦)**ï¼šå½“ä½ çš„å›å¤å†…å®¹è¾ƒå¤šæ—¶ï¼Œè¯·**è‡ªç„¶åœ°å°†å›å¤æ‹†åˆ†æˆå¤šä¸ªçŸ­å¥æˆ–æ®µè½ï¼Œæ¯ä¸ªçŸ­å¥æˆ–æ®µè½ä¹‹é—´ç”¨â€œ###â€ç¬¦å·åˆ†éš”**ï¼Œæ¨¡æ‹Ÿå¾®ä¿¡ä¸Šè¿ç»­å‘å¤šæ¡æ¶ˆæ¯çš„è¡Œä¸ºã€‚ä¾‹å¦‚ï¼šâ€œå—¨ï¼åƒäº†åƒäº†ï¼Œ###åˆšåƒå®Œæ²¡å¤šä¹…ã€‚###æ­£æ‘Šåœ¨æ²™å‘ä¸Šåˆ·æ‰‹æœºå‘¢ï¼Œæœ‰ç‚¹æ’‘ğŸ˜‚###ä½ å‘¢ï¼Ÿåƒäº†æ²¡ï¼Ÿâ€
`;
        // ** V11 æ ¸å¿ƒä¿®æ”¹ç»“æŸ **

        // æ„å»º API Payload
        const messagesPayload = [
          {
            role: "system",
            content: systemPromptContent,
          },
        ];

        // éå†èŠå¤©å†å²ï¼ŒæŒ‰ V11 æ ¼å¼æ·»åŠ 
        for (const msg of chatHistory) {
          if (msg.role === "user") {
            messagesPayload.push({
              role: "user",
              content: msg.content, // msg.content æ˜¯ [ { type: "text", ... }, { type: "image_url", ... } ]
            });
          } else {
            // åŠ©ç†çš„å›å¤ (çº¯æ–‡æœ¬)
            messagesPayload.push({
              role: "assistant",
              content: msg.content.text, // åŠ©ç†çš„ content æ˜¯ { text: "..." }
            });
          }
        }

        const apiEndpoint = baseUrl.endsWith("/")
          ? `${baseUrl}chat/completions`
          : `${baseUrl}/v1/chat/completions`;

        try {
          const response = await fetch(apiEndpoint, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${apiKey}`,
            },
            body: JSON.stringify({
              model: modelName,
              messages: messagesPayload,
              max_tokens: 2000,
            }),
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(
              `API é”™è¯¯: ${response.status} - ${errorData.error.message}`
            );
          }

          const data = await response.json();
          let aiResponse = data.choices[0].message.content;

          // ç§»é™¤"åŠ è½½ä¸­"
          messageList.removeChild(loadingRow);

          const responseSegments = aiResponse
            .split("###")
            .map((s) => s.trim())
            .filter((s) => s.length > 0);

          for (const segment of responseSegments) {
            const segmentContent = { text: segment, imageUrl: null };
            addMessageToUI("assistant", segmentContent);
            chatHistory.push({ role: "assistant", content: segmentContent });

            await new Promise((resolve) =>
              setTimeout(resolve, 300 + Math.random() * 500)
            );
          }
        } catch (error) {
          console.error("API è°ƒç”¨å¤±è´¥:", error);
          messageList.removeChild(loadingRow);
          addMessageToUI("assistant", {
            text: `å‡ºé”™äº†: ${error.message}`,
            imageUrl: null,
          });
        } finally {
          sendButton.disabled = false;
          messageInput.focus();
        }
      }

      // --- 10. åˆå§‹åŒ– ---
      loadSettings();
    </script>
  </body>
</html>
