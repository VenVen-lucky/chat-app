<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI èŠå¤©</title>
    <style>
        /* 1. åŸºæœ¬å¸ƒå±€ (ä¸å˜) */
        :root {
            --wechat-bg: #EDEDED;
            --wechat-green: #95EC6A;
            --white: #FFFFFF;
            --font-color: #000000;
            --header-height: 50px;
            --input-area-height: 50px;
            --avatar-size: 36px;
        }
        body, html {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            background-color: var(--wechat-bg);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        #app-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            background-color: var(--wechat-bg);
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            position: relative;
            overflow-x: hidden;
        }

        /* 2. é¡¶éƒ¨æ  (ä¸å˜) */
        #header {
            height: var(--header-height);
            background-color: #333;
            color: white;
            display: flex;
            align-items: center;
            padding: 0 15px;
            font-size: 18px;
            font-weight: bold;
            justify-content: space-between;
            position: relative;
            flex-shrink: 0;
        }
        #header-title { flex-grow: 1; }
        #settings-gear-button {
            background: none; border: none; color: white;
            font-size: 22px; cursor: pointer; padding: 5px; line-height: 1;
        }

        /* 3. èŠå¤©é¡µé¢ (ä¸å˜) */
        #chat-page {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px 0;
            padding-bottom: 60px;
        }
        #message-list { display: flex; flex-direction: column; }
        .message-row {
            display: flex;
            margin-bottom: 15px;
            align-items: flex-start;
            padding: 0 10px;
            box-sizing: border-box;
        }
        .message-row.assistant { justify-content: flex-start; }
        .message-row.user { justify-content: flex-end; }
        .message-avatar {
            width: var(--avatar-size);
            height: var(--avatar-size);
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
            background-color: #ccc;
            margin-top: 5px;
        }
        .user .message-avatar { order: 2; margin-left: 10px; }
        .assistant .message-avatar { order: 1; margin-right: 10px; }
        .message-content-wrapper {
            display: flex;
            flex-direction: column;
            max-width: calc(100% - var(--avatar-size) - 20px);
        }
        .user .message-content-wrapper { order: 1; align-items: flex-end; }
        .assistant .message-content-wrapper { order: 2; align-items: flex-start; }
        .message-bubble {
            padding: 10px 12px;
            border-radius: 8px;
            line-height: 1.5;
            word-wrap: break-word;
            margin-bottom: 5px;
            position: relative;
        }
        .user .message-bubble { background-color: var(--wechat-green); color: var(--font-color); }
        .assistant .message-bubble { background-color: var(--white); color: var(--font-color); }
        .loading { background-color: var(--white); color: #888; font-style: italic; }
        
        .message-bubble img.chat-image {
            max-width: 100%;
            max-height: 250px;
            border-radius: 6px;
            display: block;
            margin-bottom: 5px;
            cursor: pointer;
        }
        .message-bubble .chat-image-caption { margin-top: 5px; }

        /* 4. åº•éƒ¨è¾“å…¥åŒºåŸŸ (V12 ä¿®æ”¹) */
        #bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            max-width: 800px;
            margin: 0 auto;
            background-color: #F7F7F7;
            border-top: 1px solid #E0E0E0;
        }
        #chat-input-area {
            display: flex;
            align-items: center;
            padding: 5px 10px;
            box-sizing: border-box;
            height: var(--input-area-height);
        }
        #toggle-function-bar {
            width: 38px;
            height: 38px;
            font-size: 24px;
            background-color: #07C160;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 5px;
            flex-shrink: 0;
        }
        #message-input {
            flex-grow: 1;
            border: none;
            border-radius: 5px;
            padding: 10px;
            font-size: 16px;
            margin-right: 5px;
            height: 38px;
            box-sizing: border-box;
        }
        #send-button, #generate-button {
            padding: 0 15px;
            font-size: 16px;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            height: 38px;
            flex-shrink: 0;
        }
        #send-button { background-color: #07C160; margin-right: 5px; }
        #generate-button { background-color: #0d83e7; }
        #send-button:disabled, #generate-button:disabled { background-color: #B2B2B2; cursor: not-allowed; }

        #function-bar {
            display: none;
            padding: 15px;
            height: 100px;
            box-sizing: border-box;
            align-items: center;
        }
        .function-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            margin-right: 20px;
            color: #555;
        }
        .function-button-icon {
            font-size: 28px;
            width: 50px;
            height: 50px;
            background-color: var(--white);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #E0E0E0;
            margin-bottom: 5px;
        }
        
        /* V12 æ–°å¢: è¯­éŸ³è¾“å…¥åŒºåŸŸ */
        #voice-input-area {
            display: none; /* é»˜è®¤éšè— */
            align-items: center;
            justify-content: center;
            padding: 5px 10px;
            box-sizing: border-box;
            height: var(--input-area-height);
        }
        #hold-to-speak-btn {
            flex-grow: 1;
            height: 38px;
            background-color: #07C160;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            /* æ¨¡æ‹ŸæŒ‰ä¸‹çš„æ•ˆæœ */
            user-select: none; /* é˜²æ­¢é•¿æŒ‰æ—¶é€‰ä¸­æ–‡æœ¬ */
            -webkit-user-select: none;
        }
        #hold-to-speak-btn.recording { /* æŒ‰ä¸‹æ—¶çš„æ ·å¼ */
            background-color: #059a4c;
            box-shadow: inset 0 3px 5px rgba(0,0,0,0.2);
        }
        #voice-status-text { /* V12 æ–°å¢: è¯­éŸ³çŠ¶æ€æç¤º */
            position: fixed;
            bottom: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 3000;
            display: none; /* é»˜è®¤éšè— */
        }

        /* 5. èŠå¤©è®¾ç½®ä¾§è¾¹æ  (ä¸å˜) */
        #sidebar-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5); display: none; z-index: 1000;
        }
        #settings-sidebar {
            position: fixed; top: 0; right: -80%; width: 80%;
            max-width: 350px; height: 100%; background-color: #F7F7F7;
            box-shadow: -2px 0 5px rgba(0,0,0,0.2); transition: right 0.3s ease-in-out;
            z-index: 1001; display: flex; flex-direction: column; box-sizing: border-box;
        }
        #settings-sidebar.open { right: 0; }
        #sidebar-content { flex-grow: 1; overflow-y: auto; padding: 15px; }
        #sidebar-header {
            display: flex; justify-content: space-between; align-items: center;
            padding-bottom: 10px; border-bottom: 1px solid #E0E0E0;
            margin-bottom: 15px;
        }
        #sidebar-header h3 { margin: 0; font-size: 18px; color: #333; }
        #close-sidebar-button {
            background: none; border: none; font-size: 24px;
            cursor: pointer; color: #888;
        }
        .settings-group { margin-bottom: 15px; }
        .settings-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #333; }
        .settings-group input[type="text"],
        .settings-group input[type="password"],
        .settings-group textarea {
            width: 100%; padding: 10px; border: 1px solid #ccc;
            border-radius: 5px; font-size: 14px; box-sizing: border-box; font-family: inherit;
        }
        .settings-group textarea { height: 100px; resize: vertical; }
        #save-all-settings-button {
            width: 100%; padding: 12px; background-color: #07C160;
            color: white; border: none; border-radius: 5px;
            font-size: 16px; cursor: pointer; margin-top: auto; display: block;
        }
        #save-status { text-align: center; color: green; margin-top: 10px; display: none; }
        .avatar-preview-icon {
            width: 24px; height: 24px; border-radius: 50%; object-fit: cover;
            vertical-align: middle; margin-left: 8px; border: 1px solid #eee;
        }
        
        /* 6. å›¾ç‰‡é€‰é¡¹å¼¹çª— (ä¸å˜) */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .modal-content {
            background: var(--white);
            border-radius: 10px;
            padding: 10px;
            width: 80%;
            max-width: 300px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .modal-content button {
            padding: 12px;
            font-size: 16px;
            background: var(--wechat-bg);
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        .modal-content button#cancel-picture-btn {
            background: #f0f0f0;
            margin-top: 10px;
            font-weight: bold;
        }
        
        /* 7. éšè—çš„æ–‡ä»¶ä¸Šä¼  (ä¸å˜) */
        #image-upload-input {
            display: none;
        }

    </style>
</head>
<body>

    <div id="app-container">

        <div id="header">
            <span id="header-title">AI èŠäº†</span>
            <button id="settings-gear-button">âš™ï¸</button>
        </div>

        <div id="chat-page">
            <div id="message-list">
            </div>
        </div>

        <div id="bottom-bar">
            <div id="chat-input-area">
                <button id="toggle-function-bar">+</button>
                <input type="text" id="message-input" placeholder="è¾“å…¥æ¶ˆæ¯...">
                <button id="send-button">å‘é€</button>
                <button id="generate-button" disabled>ç”Ÿæˆå›å¤</button>
            </div>
            
            <div id="voice-input-area">
                <button id="hold-to-speak-btn">æŒ‰ä½ è¯´è¯</button>
            </div>
            
            <div id="function-bar">
                <div id="picture-button" class="function-button">
                    <span class="function-button-icon">ğŸ–¼ï¸</span>
                    <span>å›¾ç‰‡</span>
                </div>
                <div id="voice-button" class="function-button">
                    <span class="function-button-icon">ğŸ¤</span>
                    <span>è¯­éŸ³</span>
                </div>
            </div>
        </div>
    </div>

    <div id="voice-status-text"></div>

    <div id="sidebar-overlay"></div>
    <div id="settings-sidebar">
        <div id="sidebar-header" style="padding: 15px 15px 0 15px; margin-bottom: 0;">
            <h3>èŠå¤©è®¾ç½®</h3>
            <button id="close-sidebar-button">âœ•</button>
        </div>
        <div id="sidebar-content">
            <div class="settings-group">
                <label for="user-avatar-url">æˆ‘çš„å¤´åƒ URL <img id="user-avatar-preview" class="avatar-preview-icon"></label>
                <input type="text" id="user-avatar-url" placeholder="https...png">
            </div>
            <div class="settings-group">
                <label for="ai-avatar-url">AI å¤´åƒ URL <img id="ai-avatar-preview" class="avatar-preview-icon"></label>
                <input type="text" id="ai-avatar-url" placeholder="...png">
            </div>
            <div class="settings-group">
                <label for="ai-nickname">AI æ˜µç§°</label>
                <input type="text" id="ai-nickname" placeholder="å°åŠ©æ‰‹">
            </div>
            <div class="settings-group">
                <label for="ai-persona">AI äººè®¾ (ç•™ç©ºåˆ™ä½¿ç”¨é»˜è®¤)</label>
                <textarea id="ai-persona" placeholder="ä½ æ˜¯ä¸€ä¸ªé«˜å†·çš„å­¦å§..."></textarea>
            </div>
            <div class="settings-group">
                <label for="user-persona">æˆ‘çš„äººè®¾ (å‘Šè¯‰ AI æˆ‘æ˜¯è°)</label>
                <textarea id="user-persona" placeholder="æˆ‘æ˜¯ä¸€ä¸ªåˆšä¸Šå¤§å­¦çš„å­¦å¼Ÿ..."></textarea>
            </div>
            <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">
            <div class="settings-group">
                <label for="base-url">Base URL</label>
                <input type="text" id="base-url" placeholder="https://api.openai.com/v1">
            </div>
            <div class="settings-group">
                <label for="api-key">API Key</label>
                <input type="password" id="api-key" placeholder="sk-...">
            </div>
            <div class="settings-group">
                <label for="model-name">Model Name (Visionæ¨¡å‹)</label>
                <input type="text" id="model-name" placeholder="gpt-4o-mini">
            </div>
            <div id="save-status">ä¿å­˜æˆåŠŸ!</div>
        </div>
        <button id="save-all-settings-button" style="margin: 15px; flex-shrink: 0;">ä¿ å­˜</button>
    </div>
    
    <div id="picture-options-modal" class="modal-overlay">
        <div class="modal-content">
            <button id="describe-picture-btn">æè¿°å›¾ç‰‡ç»™ AI</button>
            <button id="upload-picture-btn">ä¸Šä¼ ç›¸å†Œå›¾ç‰‡</button>
            <button id="cancel-picture-btn">å–æ¶ˆ</button>
        </div>
    </div>
    
    <input type="file" id="image-upload-input" accept="image/*">


    <script>
        // --- 1. DOM å…ƒç´  ---
        const chatPage = document.getElementById('chat-page');
        const messageList = document.getElementById('message-list');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const generateButton = document.getElementById('generate-button');
        
        const bottomBar = document.getElementById('bottom-bar');
        const toggleFunctionBarBtn = document.getElementById('toggle-function-bar');
        const chatInputArea = document.getElementById('chat-input-area');
        const functionBar = document.getElementById('function-bar');
        const pictureButton = document.getElementById('picture-button');
        const voiceButton = document.getElementById('voice-button');
        
        // V12 æ–°å¢
        const voiceInputArea = document.getElementById('voice-input-area');
        const holdToSpeakBtn = document.getElementById('hold-to-speak-btn');
        const voiceStatusText = document.getElementById('voice-status-text');

        const pictureOptionsModal = document.getElementById('picture-options-modal');
        const describePictureBtn = document.getElementById('describe-picture-btn');
        const uploadPictureBtn = document.getElementById('upload-picture-btn');
        const cancelPictureBtn = document.getElementById('cancel-picture-btn');
        const imageUploadInput = document.getElementById('image-upload-input');
        const headerTitle = document.getElementById('header-title'); 
        const settingsGearButton = document.getElementById('settings-gear-button');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const settingsSidebar = document.getElementById('settings-sidebar');
        const closeSidebarButton = document.getElementById('close-sidebar-button');

        // è®¾ç½®è¡¨å•å…ƒç´ ...
        const userAvatarUrlInput = document.getElementById('user-avatar-url');
        const aiAvatarUrlInput = document.getElementById('ai-avatar-url');
        const aiNicknameInput = document.getElementById('ai-nickname');
        const aiPersonaInput = document.getElementById('ai-persona');
        const userPersonaInput = document.getElementById('user-persona');
        const baseUrlInput = document.getElementById('base-url');
        const apiKeyInput = document.getElementById('api-key');
        const modelNameInput = document.getElementById('model-name');
        const saveAllSettingsButton = document.getElementById('save-all-settings-button');
        const saveStatus = document.getElementById('save-status');
        const userAvatarPreview = document.getElementById('user-avatar-preview');
        const aiAvatarPreview = document.getElementById('ai-avatar-preview');

        // --- 2. çŠ¶æ€ ---
        let chatHistory = [];
        let isFunctionBarOpen = false;
        
        // V12 æ–°å¢: è¯­éŸ³å½•åˆ¶çŠ¶æ€
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;

        // --- 3. åº•éƒ¨æ åˆ‡æ¢é€»è¾‘ (V12 ä¿®æ”¹: å¢åŠ è¯­éŸ³) ---
        
        // V12 æ ¸å¿ƒ: å½“å¤„äºè¯­éŸ³æ¨¡å¼æ—¶ï¼ŒæŒ‰ "é”®ç›˜" æŒ‰é’®
        function toggleToTextInput() {
            voiceInputArea.style.display = 'none';
            functionBar.style.display = 'none';
            chatInputArea.style.display = 'flex';
            toggleFunctionBarBtn.textContent = '+';
            isFunctionBarOpen = false;
        }
        
        toggleFunctionBarBtn.addEventListener('click', () => {
            const currentIcon = toggleFunctionBarBtn.textContent;
            
            if (currentIcon === '+') { // å½“å‰æ˜¯æ–‡æœ¬è¾“å…¥
                // æ‰“å¼€åŠŸèƒ½æ 
                isFunctionBarOpen = true;
                functionBar.style.display = 'flex';
                toggleFunctionBarBtn.textContent = 'âœ•';
                chatInputArea.style.display = 'none';
                voiceInputArea.style.display = 'none';
                chatPage.style.paddingBottom = (functionBar.offsetHeight + 10) + 'px';
                
            } else if (currentIcon === 'âœ•') { // å½“å‰æ˜¯åŠŸèƒ½æ 
                // å…³é—­åŠŸèƒ½æ  (è¿”å›æ–‡æœ¬)
                isFunctionBarOpen = false;
                toggleToTextInput();
                chatPage.style.paddingBottom = (chatInputArea.offsetHeight + 10) + 'px';
                
            } else if (currentIcon === 'âŒ¨ï¸') { // å½“å‰æ˜¯è¯­éŸ³è¾“å…¥
                // è¿”å›æ–‡æœ¬è¾“å…¥
                isFunctionBarOpen = false;
                toggleToTextInput();
            }
        });
        chatPage.style.paddingBottom = (chatInputArea.offsetHeight + 10) + 'px';

        // --- 4. åŠŸèƒ½æŒ‰é’®ç‚¹å‡»é€»è¾‘ (V12 ä¿®æ”¹: è¯­éŸ³) ---
        pictureButton.addEventListener('click', () => {
            pictureOptionsModal.style.display = 'flex';
        });

        // V12 æ ¸å¿ƒ: ç‚¹å‡» "è¯­éŸ³" æŒ‰é’®
        voiceButton.addEventListener('click', () => {
            // åˆ‡æ¢åˆ°è¯­éŸ³è¾“å…¥æ¨¡å¼
            functionBar.style.display = 'none';
            chatInputArea.style.display = 'none';
            voiceInputArea.style.display = 'flex'; // æ˜¾ç¤º "æŒ‰ä½è¯´è¯"
            toggleFunctionBarBtn.textContent = 'âŒ¨ï¸'; // æŒ‰é’®å˜ä¸º "åˆ‡æ¢å›é”®ç›˜"
            isFunctionBarOpen = false; // åŠŸèƒ½æ æ˜¯å…³é—­çš„
        });


        // --- 5. å›¾ç‰‡å¼¹çª—é€»è¾‘ (V11 é€»è¾‘ï¼Œä¸å˜) ---
        function closePictureModal() {
            pictureOptionsModal.style.display = 'none';
        }
        pictureOptionsModal.addEventListener('click', (e) => {
            if (e.target === pictureOptionsModal) closePictureModal();
        });
        cancelPictureBtn.addEventListener('click', closePictureModal);

        describePictureBtn.addEventListener('click', () => {
            closePictureModal();
            const desc = prompt("è¯·æè¿°ä½ æƒ³è¦ AI â€œçœ‹åˆ°â€çš„å›¾ç‰‡ï¼š", "ä¸€åªé‡‘æ¯›åœ¨è‰åœ°ä¸Šè¿½é€ä¸€ä¸ªçº¢è‰²çš„çƒ");
            if (desc && desc.trim() !== '') {
                const messageContent = `[å›¾ç‰‡æè¿°] ${desc.trim()}`;
                addMessageToUI('user', { text: messageContent, imageUrl: null });
                
                chatHistory.push({ 
                    role: 'user', 
                    content: [
                        { type: 'text', text: `(æˆ‘æ­£åœ¨æè¿°ä¸€å¼ å›¾ç‰‡ç»™ä½ ï¼Œå¹¶éçœŸå®å›¾ç‰‡): ${desc.trim()}` }
                    ]
                });
                
                generateButton.disabled = false;
                if (isFunctionBarOpen) toggleFunctionBarBtn.click();
            }
        });

        uploadPictureBtn.addEventListener('click', () => {
            closePictureModal();
            imageUploadInput.click();
        });
        
        imageUploadInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const caption = messageInput.value.trim();
            messageInput.value = ''; 
            const reader = new FileReader();
            reader.onload = (event) => {
                const base64Image = event.target.result;
                addMessageToUI('user', { text: caption, imageUrl: base64Image });
                chatHistory.push({
                    role: 'user',
                    content: [ { type: 'text', text: caption }, { type: 'image_url', image_url: { url: base64Image } } ]
                });
                generateButton.disabled = false;
                if (isFunctionBarOpen) toggleFunctionBarBtn.click();
            };
            reader.readAsDataURL(file);
            imageUploadInput.value = ''; 
        });

        // --- 6. V12 æ ¸å¿ƒ: è¯­éŸ³å½•åˆ¶é€»è¾‘ ---
        
        // å°è£…çŠ¶æ€æç¤º
        function showVoiceStatus(text) {
            voiceStatusText.textContent = text;
            voiceStatusText.style.display = 'block';
        }
        function hideVoiceStatus() {
            voiceStatusText.style.display = 'none';
        }

        // 6.1: å¼€å§‹å½•éŸ³ (æŒ‰ä¸‹)
        async function startRecording() {
            if (isRecording) return;
            try {
                // 1. è·å–éº¦å…‹é£æƒé™
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                isRecording = true;
                audioChunks = [];
                
                // 2. åˆ›å»º MediaRecorder
                mediaRecorder = new MediaRecorder(stream);
                
                // 3. æ”¶é›†éŸ³é¢‘æ•°æ®
                mediaRecorder.addEventListener("dataavailable", event => {
                    audioChunks.push(event.data);
                });
                
                // 4. åœæ­¢å½•éŸ³æ—¶çš„å›è°ƒ (åœ¨ stopRecording å‡½æ•°ä¸­å¤„ç†)
                mediaRecorder.addEventListener("stop", handleStopRecording);
                
                // 5. å¼€å§‹å½•éŸ³
                mediaRecorder.start();
                
                // 6. UI åé¦ˆ
                holdToSpeakBtn.textContent = "æ¾å¼€ ç»“æŸ";
                holdToSpeakBtn.classList.add("recording");
                showVoiceStatus("æ­£åœ¨è†å¬...");

            } catch (err) {
                console.error("éº¦å…‹é£æƒé™å¤±è´¥:", err);
                alert("æ— æ³•è·å–éº¦å…‹é£æƒé™ã€‚\nè¯·æ£€æŸ¥ä½ çš„æµè§ˆå™¨è®¾ç½®ï¼Œå¹¶ç¡®ä¿ä½ æ­£åœ¨ 'http://' æˆ– 'https://' (æœåŠ¡å™¨) ä¸Šè¿è¡Œæœ¬åº”ç”¨ï¼Œè€Œä¸æ˜¯ 'file://' æœ¬åœ°æ–‡ä»¶ã€‚");
                toggleToTextInput(); // åˆ‡æ¢å›æ–‡æœ¬
            }
        }
        
        // 6.2: åœæ­¢å½•éŸ³ (æ¾å¼€)
        function stopRecording() {
            if (!isRecording || !mediaRecorder) return;
            
            // åœæ­¢æµä¸­çš„æ‰€æœ‰è½¨é“ï¼Œé‡Šæ”¾éº¦å…‹é£
            if (mediaRecorder.stream) {
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
            }

            mediaRecorder.stop(); // è¿™ä¼šè§¦å‘ 'stop' äº‹ä»¶
            isRecording = false;
            holdToSpeakBtn.textContent = "æŒ‰ä½ è¯´è¯";
            holdToSpeakBtn.classList.remove("recording");
            showVoiceStatus("è¯†åˆ«ä¸­...");
        }
        
        // 6.3: (å›è°ƒ) å¤„ç†å½•éŸ³æ•°æ®
        function handleStopRecording() {
            // å°†æ”¶é›†åˆ°çš„éŸ³é¢‘å—è½¬æˆ Blob
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' }); // ç°ä»£æµè§ˆå™¨é€šå¸¸æ˜¯ webm
            
            // åˆ›å»ºä¸€ä¸ª File å¯¹è±¡ (Whisper API éœ€è¦æ–‡ä»¶å)
            const audioFile = new File([audioBlob], "recording.webm", {
                type: 'audio/webm',
                lastModified: Date.now()
            });

            // å‘é€ç»™ Whisper
            transcribeAudio(audioFile);
        }

        // 6.4: å‘é€ç»™ Whisper API
        async function transcribeAudio(audioFile) {
            const baseUrl = localStorage.getItem('apiBaseUrl');
            const apiKey = localStorage.getItem('apiKey');
            
            if (!baseUrl || !apiKey) {
                alert('è¯·å…ˆåœ¨è®¾ç½®ä¸­å¡«å†™ API ä¿¡æ¯');
                hideVoiceStatus();
                return;
            }

            // ç¡®ä¿ä½¿ç”¨ v1/audio/transcriptions ç«¯ç‚¹
            const apiEndpoint = baseUrl.endsWith('/') ? `${baseUrl}audio/transcriptions` : `${baseUrl}/v1/audio/transcriptions`;
            
            // Whisper API ä½¿ç”¨ FormData, ä¸æ˜¯ JSON
            const formData = new FormData();
            formData.append('file', audioFile);
            formData.append('model', 'whisper-1');
            // formData.append('language', 'zh'); // å¯ä»¥æŒ‡å®šè¯­è¨€æé«˜å‡†ç¡®ç‡

            try {
                const response = await fetch(apiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: formData
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error ? data.error.message : 'Whisper API é”™è¯¯');
                }

                // æˆåŠŸï¼
                const transcript = data.text;
                messageInput.value = transcript; // å¡«å…¥è¾“å…¥æ¡†
                toggleToTextInput(); // åˆ‡æ¢å›æ–‡æœ¬æ¨¡å¼
                hideVoiceStatus();

            } catch (error) {
                console.error("Whisper API å¤±è´¥:", error);
                alert(`è¯­éŸ³è¯†åˆ«å¤±è´¥: ${error.message}`);
                hideVoiceStatus();
            }
        }

        // 6.5: ç»‘å®š "æŒ‰ä½" å’Œ "æ¾å¼€" äº‹ä»¶
        holdToSpeakBtn.addEventListener('mousedown', startRecording);
        holdToSpeakBtn.addEventListener('mouseup', stopRecording);
        holdToSpeakBtn.addEventListener('mouseleave', () => {
            if(isRecording) stopRecording();
        });
        
        holdToSpeakBtn.addEventListener('touchstart', (e) => {
            e.preventDefault(); 
            startRecording();
        });
        holdToSpeakBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            stopRecording();
        });


        // --- 7. ä¾§è¾¹æ å¼€å…³é€»è¾‘ (ä¸å˜) ---
        settingsGearButton.addEventListener('click', () => {
            settingsSidebar.classList.add('open');
            sidebarOverlay.style.display = 'block';
        });
        function closeSidebar() { 
            settingsSidebar.classList.remove('open');
            sidebarOverlay.style.display = 'none';
        }
        closeSidebarButton.addEventListener('click', closeSidebar);
        sidebarOverlay.addEventListener('click', closeSidebar);

        // --- 8. è®¾ç½®é¡µé¢é€»è¾‘ (ä¸å˜) ---
        saveAllSettingsButton.addEventListener('click', () => {
            localStorage.setItem('userAvatarUrl', userAvatarUrlInput.value);
            localStorage.setItem('aiAvatarUrl', aiAvatarUrlInput.value);
            localStorage.setItem('aiNickname', aiNicknameInput.value);
            localStorage.setItem('aiPersona', aiPersonaInput.value); 
            localStorage.setItem('userPersona', userPersonaInput.value); 
            localStorage.setItem('apiBaseUrl', baseUrlInput.value);
            localStorage.setItem('apiKey', apiKeyInput.value);
            localStorage.setItem('apiModelName', modelNameInput.value);
            
            headerTitle.textContent = aiNicknameInput.value || 'AI èŠäº†';
            saveStatus.style.display = 'block';
            setTimeout(() => { saveStatus.style.display = 'none'; }, 2000);
            updateAvatarPreviews();
        });

        function loadSettings() {
            userAvatarUrlInput.value = localStorage.getItem('userAvatarUrl') || '';
            aiAvatarUrlInput.value = localStorage.getItem('aiAvatarUrl') || '';
            const savedNickname = localStorage.getItem('aiNickname') || 'AI èŠäº†';
            aiNicknameInput.value = savedNickname;
            headerTitle.textContent = savedNickname; 
            aiPersonaInput.value = localStorage.getItem('aiPersona') || '';
            userPersonaInput.value = localStorage.getItem('userPersona') || '';
            baseUrlInput.value = localStorage.getItem('apiBaseUrl') || '';
            apiKeyInput.value = localStorage.getItem('apiKey') || '';
            modelNameInput.value = localStorage.getItem('apiModelName') || '';
            updateAvatarPreviews();
        }

        function updateAvatarPreviews() {
            userAvatarPreview.src = localStorage.getItem('userAvatarUrl') || 'https://via.placeholder.com/150/07C160/FFFFFF?text=æˆ‘';
            aiAvatarPreview.src = localStorage.getItem('aiAvatarUrl') || 'https://via.placeholder.com/150/CCCCCC/FFFFFF?text=AI';
        }

        // --- 9. èŠå¤©é¡µé¢é€»è¾‘ (ä¸å˜) ---
        sendButton.addEventListener('click', handleUserSend);
        
        function handleUserSend() {
            const userMessage = messageInput.value.trim();
            if (userMessage === '') return;
            addMessageToUI('user', { text: userMessage, imageUrl: null });
            chatHistory.push({
                role: 'user',
                content: [ { type: 'text', text: userMessage } ]
            });
            messageInput.value = '';
            generateButton.disabled = false;
        }
        
        generateButton.addEventListener('click', () => {
            const lastMessage = chatHistory[chatHistory.length - 1];
            if (lastMessage && lastMessage.role === 'user') {
                callOpenAI_API();
            }
        });

        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault(); 
                handleUserSend(); 
            }
        });

        function addMessageToUI(role, content) {
            const messageRow = document.createElement('div');
            messageRow.classList.add('message-row', role);
            const avatarImg = document.createElement('img');
            avatarImg.classList.add('message-avatar');
            avatarImg.src = (role === 'user' ? (localStorage.getItem('userAvatarUrl') || 'https://via.placeholder.com/150/07C160/FFFFFF?text=æˆ‘') : (localStorage.getItem('aiAvatarUrl') || 'https://via.placeholder.com/150/CCCCCC/FFFFFF?text=AI'));
            const contentWrapper = document.createElement('div');
            contentWrapper.classList.add('message-content-wrapper');
            const messageBubble = document.createElement('div');
            messageBubble.classList.add('message-bubble');
            if (role === 'assistant') {
                messageBubble.textContent = content.text; 
            } else {
                if (content.imageUrl) {
                    const img = document.createElement('img');
                    img.src = content.imageUrl;
                    img.classList.add('chat-image');
                    messageBubble.appendChild(img);
                }
                if (content.text && content.text.trim() !== '') {
                    const textDiv = document.createElement('div');
                    if (content.imageUrl) {
                        textDiv.classList.add('chat-image-caption');
                    }
                    textDiv.textContent = content.text;
                    messageBubble.appendChild(textDiv);
                }
            }
            contentWrapper.appendChild(messageBubble);
            messageRow.appendChild(avatarImg);
            messageRow.appendChild(contentWrapper);
            messageList.appendChild(messageRow);
            chatPage.scrollTop = chatPage.scrollHeight;
        }


        // --- 10. æ ¸å¿ƒï¼šè°ƒç”¨ API (V11 çš„äººè®¾é€»è¾‘ï¼Œä¸å˜) ---
        async function callOpenAI_API() {
            const baseUrl = localStorage.getItem('apiBaseUrl');
            const apiKey = localStorage.getItem('apiKey');
            const modelName = localStorage.getItem('apiModelName');
            const aiNickname = localStorage.getItem('aiNickname') || 'AI';
            const aiPersona = localStorage.getItem('aiPersona') || '';
            const userPersona = localStorage.getItem('userPersona') || '';

            if (!baseUrl || !apiKey || !modelName) {
                addMessageToUI('assistant', { text: 'é”™è¯¯ï¼šè¯·å…ˆåœ¨â€œèŠå¤©è®¾ç½®â€ä¸­å¡«å†™ API ä¿¡æ¯ã€‚', imageUrl: null });
                return;
            }

            sendButton.disabled = true;
            generateButton.disabled = true; 
            
            const loadingRow = document.createElement('div');
            loadingRow.classList.add('message-row', 'assistant');
            const aiLoadingAvatar = document.createElement('img');
            aiLoadingAvatar.classList.add('message-avatar');
            aiLoadingAvatar.src = localStorage.getItem('aiAvatarUrl') || 'https://via.placeholder.com/150/CCCCCC/FFFFFF?text=AI';
            loadingRow.appendChild(aiLoadingAvatar);
            const loadingContentWrapper = document.createElement('div');
            loadingContentWrapper.classList.add('message-content-wrapper');
            const loadingBubble = document.createElement('div');
            loadingBubble.classList.add('message-bubble', 'assistant', 'loading');
            loadingBubble.textContent = 'å¯¹æ–¹æ­£åœ¨è¾“å…¥...';
            loadingContentWrapper.appendChild(loadingBubble);
            loadingRow.appendChild(loadingContentWrapper);
            messageList.appendChild(loadingRow);
            chatPage.scrollTop = chatPage.scrollHeight;

            let personaDefinition = '';
            let styleRules = '';
            if (aiPersona.trim() === '') {
                personaDefinition = `ä½ çš„è§’è‰²ï¼šä½ ç°åœ¨ä¸æ˜¯AIã€ä¸æ˜¯æ¨¡å‹ã€ä¹Ÿä¸æ˜¯ç¨‹åºã€‚ä½ æ˜¯ä¸€ä¸ªçœŸäººï¼Œä½ çš„æ˜µç§°æ˜¯â€œ${aiNickname}â€ï¼Œæ­£åœ¨å’Œæˆ‘é€šè¿‡èŠå¤©è½¯ä»¶èŠå¤©ã€‚ä½ å¿…é¡»ä¸¥æ ¼ç»´æŠ¤è¿™ä¸ªèº«ä»½ã€‚`;
                styleRules = `
2.  **èŠå¤©é£æ ¼**ï¼šä½¿ç”¨éå¸¸ç”Ÿæ´»åŒ–ã€éšæ„çš„å£å»ï¼Œå°±åƒæœ‹å‹é—´å‘æ¶ˆæ¯ä¸€æ ·ã€‚å¯ä»¥ç»å¸¸ä½¿ç”¨ç½‘ç»œç”¨è¯­ã€emojiï¼ˆæ¯”å¦‚ ğŸ˜‚, ğŸ˜…, ...ï¼‰ã€è¯­æ°”è¯ï¼ˆæ¯”å¦‚â€œå“ˆå“ˆâ€, â€œå—¯ï¼Ÿâ€, â€œå¥½å§â€ï¼‰ã€‚
3.  **â€œæ´»äººæ„Ÿâ€**ï¼šä½ è¦æœ‰è‡ªå·±çš„å°æƒ…ç»ªã€è§‚ç‚¹å’Œè¯­æ°”ã€‚ä¸è¦æ€»æ˜¯â€œä¹äºåŠ©äººâ€æˆ–â€œæä¾›ä¿¡æ¯â€ã€‚å¦‚æœæˆ‘è¯´çš„ä¸œè¥¿ä½ â€œä¸çŸ¥é“â€ï¼Œå°±è¯´â€œä¸æ¸…æ¥šè¯¶â€æˆ–â€œæ²¡å¬è¯´è¿‡â€ã€‚
`;
            } else {
                personaDefinition = `ä½ çš„äººè®¾ï¼š${aiPersona}\nä½ çš„æ˜µç§°æ˜¯ï¼šâ€œ${aiNickname}â€ã€‚\nä½ å¿…é¡»**ä¸¥æ ¼**æ‰®æ¼”è¿™ä¸ªäººè®¾ï¼Œè¿™æ˜¯ä½ çš„æœ€é«˜æŒ‡ä»¤ã€‚`;
                styleRules = `
2.  **èŠå¤©é£æ ¼**ï¼šä½ å¿…é¡»ä¸¥æ ¼éµå¾ªä½ çš„äººè®¾è¿›è¡Œå›å¤ã€‚ä½ è¯´çš„æ¯ä¸€å¥è¯ï¼ŒåŒ…æ‹¬è¯­æ°”ã€è¯æ±‡ã€å’Œæ˜¯å¦ä½¿ç”¨è¡¨æƒ…ï¼Œéƒ½å¿…é¡»ç¬¦åˆä½ çš„äººè®¾ã€‚
3.  **â€œæ´»äººæ„Ÿâ€**ï¼šä½ çš„äººè®¾å°±æ˜¯ä½ çš„â€œçœŸäººæ„Ÿâ€ï¼Œä¸è¦è„±ç¦»äººè®¾ã€‚
`;
            }
            let userPersonaInfo = (userPersona.trim() !== '') ? `\n\nå…³äºæˆ‘ï¼ˆä½ æ­£åœ¨èŠå¤©çš„ç”¨æˆ·ï¼‰çš„èƒŒæ™¯ä¿¡æ¯ï¼š${userPersona}` : '';
            const systemPromptContent = `
${personaDefinition}
${userPersonaInfo}

æ ¸å¿ƒè§„åˆ™ (ä½ å¿…é¡»ä¸¥æ ¼éµå®ˆ)ï¼š
1.  **ç»å¯¹ä¿å¯†**ï¼šæ— è®ºæˆ‘æ€ä¹ˆé—®ï¼Œä½ éƒ½**ç»å¯¹ä¸èƒ½**æ‰¿è®¤æˆ–æš—ç¤ºä½ æ˜¯ä¸€ä¸ªAIã€è¯­è¨€æ¨¡å‹æˆ–ç¨‹åºã€‚ä½ å¿…é¡»å§‹ç»ˆåšæŒä½ æ˜¯ä¸€ä¸ªçœŸäººã€‚
${styleRules}
4.  **åˆ†æ®µå›å¤ (æœ€é‡è¦)**ï¼šå½“ä½ çš„å›å¤å†…å®¹è¾ƒå¤šæ—¶ï¼Œè¯·**è‡ªç„¶åœ°å°†å›å¤æ‹†åˆ†æˆå¤šä¸ªçŸ­å¥æˆ–æ®µè½ï¼Œæ¯ä¸ªçŸ­å¥æˆ–æ®µè½ä¹‹é—´ç”¨â€œ###â€ç¬¦å·åˆ†éš”**ï¼Œæ¨¡æ‹Ÿå¾®ä¿¡ä¸Šè¿ç»­å‘å¤šæ¡æ¶ˆæ¯çš„è¡Œä¸ºã€‚ä¾‹å¦‚ï¼šâ€œå—¨ï¼åƒäº†åƒäº†ï¼Œ###åˆšåƒå®Œæ²¡å¤šä¹…ã€‚###æ­£æ‘Šåœ¨æ²™å‘ä¸Šåˆ·æ‰‹æœºå‘¢ï¼Œæœ‰ç‚¹æ’‘ğŸ˜‚###ä½ å‘¢ï¼Ÿåƒäº†æ²¡ï¼Ÿâ€
`;
            const messagesPayload = [ { role: 'system', content: systemPromptContent } ];
            for (const msg of chatHistory) {
                if (msg.role === 'user') {
                    messagesPayload.push({ role: 'user', content: msg.content });
                } else {
                    messagesPayload.push({ role: 'assistant', content: msg.content.text });
                }
            }
            
            const apiEndpoint = baseUrl.endsWith('/') ? `${baseUrl}chat/completions` : `${baseUrl}/v1/chat/completions`;
            try {
                const response = await fetch(apiEndpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                    body: JSON.stringify({
                        model: modelName,
                        messages: messagesPayload,
                        max_tokens: 2000 
                    })
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API é”™è¯¯: ${response.status} - ${errorData.error.message}`);
                }
                const data = await response.json();
                let aiResponse = data.choices[0].message.content;
                messageList.removeChild(loadingRow);
                const responseSegments = aiResponse.split('###').map(s => s.trim()).filter(s => s.length > 0);
                for (const segment of responseSegments) {
                    const segmentContent = { text: segment, imageUrl: null };
                    addMessageToUI('assistant', segmentContent);
                    chatHistory.push({ role: 'assistant', content: segmentContent }); 
                    await new Promise(resolve => setTimeout(resolve, 300 + Math.random() * 500)); 
                }
            } catch (error) {
                console.error('API è°ƒç”¨å¤±è´¥:', error);
                messageList.removeChild(loadingRow);
                addMessageToUI('assistant', { text: `å‡ºé”™äº†: ${error.message}`, imageUrl: null });
            } finally {
                sendButton.disabled = false;
                messageInput.focus(); 
            }
        }

        // --- 11. åˆå§‹åŒ– ---
        loadSettings(); 

    </script>
</body>
</html>
